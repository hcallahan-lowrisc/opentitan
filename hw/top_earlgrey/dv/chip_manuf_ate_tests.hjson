// Copyright lowRISC contributors (OpenTitan project).
// Licensed under the Apache License, Version 2.0, see LICENSE for details.
// SPDX-License-Identifier: Apache-2.0
{
  # This auxiliary chip sim cfg specification focuses on chip level manufacturing tests.
  # Please see chip_sim_cfg.hjson for full setup details.

  # Note: Please maintain alphabetical order.
  tests: [
    {
      name: ate_bootstrap_flash_erase
      uvm_test_seq: chip_sw_ate_bootstrap_flash_erase_vseq
      # We do not need to load any flash images as this test is entirely host driven.
      sw_images: []
      en_run_modes: ["sw_test_mode_test_rom"]
      run_opts: [
        "+sw_test_timeout_ns=160_000_000"
        "+skip_flash_bkdr_load=1",
        "+use_spi_load_bootstrap=1",
      ]
      run_timeout_mins: 180
    }
    {
      name: ate_bootstrap_one_frame
      uvm_test_seq: chip_sw_ate_bootstrap_one_frame_vseq
      sw_images: ["//sw/device/silicon_creator/manuf/tests:manuf_scrap_functest_prod:1:new_rules"]
      en_run_modes: ["sw_test_mode_test_rom"]
      run_opts: [
        "+sw_test_timeout_ns=160_000_000"
        "+skip_flash_bkdr_load=1",
        "+use_spi_load_bootstrap=1",
      ]
      run_timeout_mins: 180
    }
    {
      name: ate_bootstrap_disjoint
      uvm_test_seq: chip_sw_ate_bootstrap_disjoint_vseq
      sw_images: ["//sw/device/silicon_creator/manuf/tests:multislot_empty_test:1:new_rules"]
      en_run_modes: ["sw_test_mode_test_rom"]
      run_opts: [
        "+sw_test_timeout_ns=1_000_000_000"
        "+skip_flash_bkdr_load=1",
        "+use_spi_load_bootstrap=1",
      ]
      run_timeout_mins: 800
    }
    {
      name: rom_e2e_bootstrap_ate_smoke
      uvm_test_seq: chip_sw_rom_e2e_ate_smoke_vseq
      sw_images: [
        "//sw/device/silicon_creator/rom/e2e/ate/binaries:ate_gpio_toggle_test:1:silicon_creator:signed",
        "//hw/ip/otp_ctrl/data/earlgrey_skus/sival:otp_img_dev_manuf_personalized:4"
      ]
      en_run_modes: ["sw_test_mode_test_rom"]
      run_opts: [
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpTypeCustom",
        "+skip_flash_bkdr_load=0",
        "+use_spi_load_bootstrap=0",
      ]
      run_timeout_mins: 800
    }
    {
      name: rom_e2e_ft_perso_base
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_base_vseq
      sw_images: [
        // Add the 'silicon_creator' flag because the default 'sw_build_device' of sim_dv does
        // not enable the OTTF, and hence we cannot interact with the perso binary over the
        // spi_console. (sim_dv assumes use of the sw_logger_if instead of the OTTF)
        "//sw/device/silicon_creator/manuf/base:ft_personalize_emulation:1:silicon_creator:dont_filter",
        "//hw/ip/otp_ctrl/data/earlgrey_skus/emulation:otp_img_dev_manuf_individualized:4"
        "//sw/device/lib/testing/test_rom:test_rom:0"
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpTypeCustom",
        "+skip_flash_bkdr_load=1",      // Do not pre-load flash in dut_init() at the start of simulation
                                        // Flash-loading is handled entirely in the leaf vseq
        "+use_spi_load_bootstrap=1", /* This variable SHOULD BE is irrelevant if +skip_flash_bkdr_load=1 */
        "+dump_mems=1",
        "+load_mems=0",
        "+perso_start_phase=0",
        "+RMA_UNLOCK_TOKEN_HASH_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH",
        "+RMA_UNLOCK_TOKEN_HASH_CRC_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH_CRC",
        "+MANUF_PERSO_DATA_BACK_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_MANUF_PERSO_DATA_BACK",
        "+PERSO_CERTGEN_INPUTS_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_PERSO_CERTGEN_INPUTS",
      ]
      run_timeout_mins: 1000
    }
    {
      // This test runs the full FT-Personalize provisioning step
      name: rom_e2e_ft_personalize_sival
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_vseq
      sw_images: [
        "//sw/device/silicon_creator/manuf/base/binaries:ft_personalize_sival:1:silicon_creator:signed",
        "//hw/ip/otp_ctrl/data/earlgrey_skus/sival:otp_img_dev_manuf_individualized:4"
        "//sw/device/lib/testing/test_rom:test_rom:0"
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        // "+sw_test_timeout_ns=1_000_000_000",
        "+sw_test_timeout_ns=1_000_000_000",
        "+use_otp_image=OtpNone",
        "+dumped_bank0_init={proj_root}/binaries/ft_personalize_sival/dump_FlashBank0Data.64.scr.vmem",
        "+skip_flash_bkdr_load=1",        // Do not backdoor-load Flash
        "+use_spi_load_bootstrap=0",      // Do not SPI-Bootstrap
      ]
      run_timeout_mins: 800
    }
    {
      // This test is used to dump the Flash contents after SPI-bootstrapping...
      name: rom_e2e_ft_perso_sival_transport_dump
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_dump_vseq
      sw_images: [
        "//sw/device/silicon_creator/manuf/base/binaries:ft_personalize_sival:1:silicon_creator:signed",
        "//hw/ip/otp_ctrl/data/earlgrey_skus/sival:otp_img_dev_manuf_individualized:4"
        "//sw/device/lib/testing/test_rom:test_rom:0"
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpTypeCustom",
        "+skip_flash_bkdr_load=1",         // Do not Backdoor-load Flash
        "+use_spi_load_bootstrap=1",       // Use SPI-Bootstrap in chip_sw_base_vseq
      ]
      run_timeout_mins: 800
    }
    {
      // This test runs the simulation after the perso bootstrapping process has updated the SECRET1 flash
      // scrambling keys and re-bootstrapped the transport image.
      // It begins by loading OTP and Flash .vmem dumps of the chip state after the transport image has been loaded.
      name: rom_e2e_ft_perso_sival_transport_backdoor
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_bkdr_transport_vseq
      sw_images: [
        "//sw/device/lib/testing/test_rom:test_rom:0"
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpNone",
        "+dumped_otp_transport={proj_root}/binaries/ft_personalize_sival/dump_OTP_transportinit.24.vmem",
        "+dumped_bank0_transport={proj_root}/binaries/ft_personalize_sival/dump_FlashBank0Data_transport.64.scr.vmem",
        "+skip_flash_bkdr_load=1",        // Do not backdoor-load Flash
        "+use_spi_load_bootstrap=0",      // Do not SPI-Bootstrap
        "+RMA_UNLOCK_TOKEN_HASH_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH",
        "+RMA_UNLOCK_TOKEN_HASH_CRC_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH_CRC",
        "+MANUF_PERSO_DATA_BACK_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_MANUF_PERSO_DATA_BACK",
        "+PERSO_CERTGEN_INPUTS_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_PERSO_CERTGEN_INPUTS",
      ]
      run_timeout_mins: 60
    }
    {
      // This test is used to dump the Flash contents after SPI-bootstrapping...
      name: rom_e2e_ft_perso_emu_transport_dump
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_dump_vseq
      sw_images: [
        // Add the 'silicon_creator' flag because the default 'sw_build_device' of sim_dv does
        // not enable the OTTF, and hence we cannot interact with the perso binary over the
        // spi_console. (sim_dv assumes use of the sw_logger_if instead of the OTTF)
        "//sw/device/silicon_creator/manuf/base:ft_personalize_emulation:1:silicon_creator:dont_filter",
        "//hw/ip/otp_ctrl/data/earlgrey_skus/emulation:otp_img_dev_manuf_individualized:4"
        "//sw/device/lib/testing/test_rom:test_rom:0"
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpTypeCustom",
        "+skip_flash_bkdr_load=1",         // Do not Backdoor-load Flash
        "+use_spi_load_bootstrap=1",       // Use SPI-Bootstrap in chip_sw_base_vseq
      ]
      run_timeout_mins: 800
    }
    {
      // This test runs the simulation after the perso bootstrapping process has updated the SECRET1 flash
      // scrambling keys and re-bootstrapped the transport image.
      // It begins by loading OTP and Flash .vmem dumps of the chip state after the transport image has been loaded.
      name: rom_e2e_ft_perso_emu_transport_backdoor
      uvm_test_seq: chip_sw_rom_e2e_ft_perso_bkdr_transport_vseq
      sw_images: [
        "//sw/device/lib/testing/test_rom:test_rom:0",
        // Add the test binary here, just so we get the disassembly in the run-dir for debugging purposes.
        "//sw/device/silicon_creator/manuf/base:ft_personalize_emulation:1:silicon_creator:dont_filter",
      ]
      en_run_modes: ["sw_test_mode_base"]
      run_opts: [
        "+disable_assert_final_checks",
        "+sw_test_timeout_ns=1000000000",
        "+use_otp_image=OtpNone",
        "+dumped_otp_transport={proj_root}/binaries/ft_personalize_emulation/dump_OTP_transportinit.24.vmem",
        "+dumped_otp_perso_secrets={proj_root}/binaries/ft_personalize_emulation/dump_OTP_perso_secrets.24.vmem",
        "+dumped_bank0_transport={proj_root}/binaries/ft_personalize_emulation/dump_FlashBank0Data_transport.64.scr.vmem",
        "+bank0_gen={proj_root}/binaries/ft_personalize_emulation/FlashBank0Data_transport_gen.64.scr.vmem"
        "+skip_flash_bkdr_load=1",        // Do not backdoor-load Flash
        "+use_spi_load_bootstrap=0",      // Do not SPI-Bootstrap
        "+RMA_UNLOCK_TOKEN_HASH_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH",
        "+RMA_UNLOCK_TOKEN_HASH_CRC_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_RMA_TOKEN_UNLOCK_HASH_CRC",
        "+MANUF_PERSO_DATA_BACK_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_MANUF_PERSO_DATA_BACK",
        "+PERSO_CERTGEN_INPUTS_FILE={proj_root}/binaries/ft_personalize_orch_emu_cw340/ujson_PERSO_CERTGEN_INPUTS",
      ]
      run_timeout_mins: 180
    }
  ]

  regressions: [
    {
      name: ate_tests
      tests: [
        "rom_e2e_bootstrap_ate_smoke",
        "rom_e2e_ft_personalize_sival",
      ]
    }
  ]
}
